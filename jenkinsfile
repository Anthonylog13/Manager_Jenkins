pipeline {
    agent any // Tu agente Windows

    environment {
        AWS_REGION         = 'us-east-2'
        ECR_PUBLIC_REGION  = 'us-east-1' 
        AWS_CREDS_ID       = 'aws-manageJenkins' // Tu ID de credencial AWS
    }

    stages {
        stage('Clonar Repositorio Basico') { // Solo para tener un checkout
            steps {
                echo "==> Clonando repositorio (paso mínimo)..."
                checkout scm
            }
        }

        stage('Test AWS CLI Execution') {
            steps {
                echo "==> Intentando ejecutar AWS CLI directamente..."
                script {
                    // ¡AJUSTA ESTA RUTA SI TU AWS CLI ESTÁ EN OTRO LADO EN WINDOWS!
                    def awsCliFullPath = 'C:\\Program Files\\Amazon\\AWSCLIV2\\aws.exe'
                    def testAwsCommand = "\"${awsCliFullPath}\" --version"

                    try {
                        echo "Ejecutando comando: ${testAwsCommand}"
                        def cliOutput = bat(script: testAwsCommand, returnStdout: true).trim()
                        
                        if (cliOutput && !cliOutput.isEmpty()) {
                            echo "AWS CLI ejecutado con éxito. Salida:"
                            echo cliOutput
                        } else {
                            def awsCmdExitCode = bat(script: testAwsCommand, returnStatus: true)
                            error("Fallo al ejecutar AWS CLI o no hubo salida. Código de salida: ${awsCmdExitCode}")
                        }

                    } catch (e) {
                        echo "EXCEPCIÓN al ejecutar AWS CLI: ${e.getMessage()}"
                        if (e.getStackTrace()) {
                            e.getStackTrace().each { line -> echo line.toString() }
                        }
                        throw e 
                    }
                }
            }
        }

        stage('Test AWS CLI con withAWS') {
            steps {
                echo "==> Intentando ejecutar AWS CLI usando withAWS..."
                withAWS(credentials: AWS_CREDS_ID, region: ECR_PUBLIC_REGION) {
                    script {
                        // ¡AJUSTA ESTA RUTA SI TU AWS CLI ESTÁ EN OTRO LADO EN WINDOWS!
                        def awsCliFullPath = 'C:\\Program Files\\Amazon\\AWSCLIV2\\aws.exe'
                        def testAwsCommandWithCreds = "\"${awsCliFullPath}\" sts get-caller-identity"

                        try {
                            echo "Ejecutando comando con withAWS: ${testAwsCommandWithCreds}"
                            def cliOutputWithCreds = bat(script: testAwsCommandWithCreds, returnStdout: true).trim()

                            if (cliOutputWithCreds && !cliOutputWithCreds.isEmpty()) {
                                echo "AWS CLI con withAWS ejecutado con éxito. Salida:"
                                echo cliOutputWithCreds
                            } else {
                                def awsCmdExitCodeWithCreds = bat(script: testAwsCommandWithCreds, returnStatus: true)
                                error("Fallo al ejecutar AWS CLI con withAWS o no hubo salida. Código de salida: ${awsCmdExitCodeWithCreds}")
                            }

                        } catch (e) {
                            echo "EXCEPCIÓN al ejecutar AWS CLI con withAWS: ${e.getMessage()}"
                            if (e.getStackTrace()) {
                                e.getStackTrace().each { line -> echo line.toString() }
                            }
                            throw e 
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            echo "Pipeline de diagnóstico finalizado."
        }
    }
}